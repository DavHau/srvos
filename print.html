<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>SrvOS - NixOS for your server</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="hello.html"><strong aria-hidden="true">1.</strong> Hello</a></li><li class="chapter-item expanded "><a href="nixos.html"><strong aria-hidden="true">2.</strong> NixOS modules</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="nixos/general.html"><strong aria-hidden="true">2.1.</strong> General</a></li><li class="chapter-item expanded "><a href="nixos/hardware.html"><strong aria-hidden="true">2.2.</strong> Hardware</a></li><li class="chapter-item expanded "><a href="nixos/mixins.html"><strong aria-hidden="true">2.3.</strong> Mixins</a></li><li class="chapter-item expanded "><a href="nixos/roles.html"><strong aria-hidden="true">2.4.</strong> Roles</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="nixos/roles/github_actions_runner.html"><strong aria-hidden="true">2.4.1.</strong> GitHub Action Runner</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="installation.html"><strong aria-hidden="true">3.</strong> Installation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="installation/hetzner_cloud.html"><strong aria-hidden="true">3.1.</strong> Hetzner Cloud</a></li></ol></li><li class="chapter-item expanded "><a href="design.html"><strong aria-hidden="true">4.</strong> Design</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">SrvOS - NixOS for your server</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="hello"><a class="header" href="#hello">Hello</a></h1>
<p>SrvOS is a collection of opinionated and sharable NixOS configurations.</p>
<p>As we learn more about NixOS in various deployments, we end up re-writing the same modules and configs. This is a way for us to speed up and share our setups.</p>
<p>Instead of supporting everything, our goal is to target certain verticals and make the support super smooth there.</p>
<h2 id="quick-usage"><a class="header" href="#quick-usage">Quick Usage</a></h2>
<p>Add <code>srvos</code> to your <code>flake.nix</code> to augment your NixOS configuration. For
example to deploy a GitHub Action runner on Hetzner:</p>
<pre><code class="language-nix">{
  inputs = {
    srvos.url = &quot;github:numtide/srvos&quot;;
  };
  outputs = { srvos, nixpkgs, ... }: {
    nixosConfigurations.myHost = nixpkgs.lib.nixosSystem {
      system = &quot;x86_64-linux&quot;;
      modules = [
        srvos.nixosModules.common
        srvos.nixosModules.hardware-hetzner-amd
        srvos.nixosModules.roles-github-actions-runner
      ];
    };
  };
}
</code></pre>
<h2 id="technologies"><a class="header" href="#technologies">Technologies</a></h2>
<p>SrvOS is a thin wrapper, sitting on the shoulder of others:</p>
<ul>
<li><a href="https://nixos.org">Nix and NixOS</a> of course.</li>
<li><a href="https://github.com/numtide/nixos-anywhere">nixos-anywhere</a> to bootstrap new systems.</li>
<li><a href="https://github.com/nix-community/disko">disko</a> to partition and configure disks.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="nixos-modules"><a class="header" href="#nixos-modules">NixOS modules</a></h2>
<p>All modules are defined in the repo's top-level <code>default.nix</code></p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="general"><a class="header" href="#general">General</a></h2>
<p>Used to define the type of machine.</p>
<ul>
<li><code>server</code>:
<ul>
<li>Use this for headless systems that are remotely managed via ssh</li>
<li>Includes everything from common</li>
<li>Disables desktop features like sound</li>
<li>Defaults to UTC</li>
<li>Enables ssh</li>
<li>Configures watchdog for reboot</li>
<li>Sets up sudo without password</li>
<li>...</li>
</ul>
</li>
<li><code>desktop</code>:
<ul>
<li>Mostly based on common but also includes some optimization for useful for interactive usage</li>
</ul>
</li>
<li><code>common</code>:
<ul>
<li>Use if you are unsure if your nixos module will be used on server or desktop</li>
<li>Better nix-daemon defaults</li>
<li>Better serial console support</li>
<li>Colored package diffs on nixos-rebuild</li>
<li>Use systemd in initrd by default and networkd as a backend for the
Networking module</li>
<li>Do not block on networkd/networkmanager's online target</li>
<li>Better zfs defaults</li>
<li>Add well-known ssh git ssh keys to the git configuration</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="hardware"><a class="header" href="#hardware">Hardware</a></h2>
<p>NixOS hardware configurations that we know about.</p>
<ul>
<li><code>hardware-amazon</code>: Amazon AWS virtual machines</li>
<li><code>hardware-hetzner-cloud</code>: Hardware and network defaults for Hetzner virtual machine</li>
<li><code>hardware-hetzner-amd</code>: Hardware and network defaults for Hetzner bare-metal servers for AMD and Intel cpus.</li>
<li><code>hardware-hetzner-intel</code>: &quot;</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="mixins"><a class="header" href="#mixins">Mixins</a></h2>
<p>Config extensions for a given machine.</p>
<ul>
<li><code>mixins-cloud-init</code> enables <a href="https://cloud-init.io">cloud-init</a></li>
<li><code>mixins-systemd-boot</code> configure systemd-boot as bootloader</li>
<li><code>mixins-telegraf</code> enables a generic telegraf configuration. See <a href="https://github.com/Mic92/dotfiles/blob/master/nixos/eva/modules/prometheus/alert-rules.nix">Mic's dotfiles</a>
for monitoring rules targeting this telegraf configuration.</li>
<li><code>mixins-nginx</code> recommended nginx settings</li>
<li><code>mixins-trusted-nix-caches</code> list of trust-worthy public binary caches</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="roles"><a class="header" href="#roles">Roles</a></h2>
<p>Designed to take over a machine with the given role.</p>
<ul>
<li><a href="nixos/./roles/github_actions_runner.html">roles-github-actions-runner</a> configures <a href="https://docs.github.com/en/actions/hosting-your-own-runners/about-self-hosted-runners">GitHub
self hosted actions runner</a> on a machine</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="github-action-runner"><a class="header" href="#github-action-runner">GitHub Action Runner</a></h1>
<p>This role installs:</p>
<ul>
<li>One or more self hosted github action runner</li>
<li>One <a href="https://www.cachix.org">cachix</a> watch store service</li>
</ul>
<h2 id="authentication"><a class="header" href="#authentication">Authentication</a></h2>
<p>There are different ways a self hosted runner can register itself by GitHub.</p>
<ul>
<li>Using a Registration token</li>
<li>Using a Personal Authentication token</li>
<li>Using a GitHub App</li>
</ul>
<p>We will document hereafter how to connect using a new GitHub Application in your organization.</p>
<p>First, create the GitHub Application in <code>https://github.com/organizations/&lt;YOUR ORGANIZATION&gt;/settings/apps</code></p>
<ul>
<li>Click on <code>New GitHub App</code>.</li>
<li>In &quot;GitHub App name&quot; type <code>&lt;YOUR ORGANISATION&gt; App for GitHub runners</code>.</li>
<li>In &quot;Homepage&quot; fill in your project URL. It is required but won't be used hereafter.</li>
<li>Unselect <code>Expire user authorization tokens</code>.</li>
<li>Unselect <code>Active</code> in the &quot;Webhook&quot; section.</li>
<li>In the &quot;Organization permissions&quot; select <code>Read and write</code> next to the &quot;Self-hosted runner&quot; permission</li>
<li>Click on <code>Create GitHub App</code></li>
</ul>
<p>You should save securely the generated pem encoded private key. We will use that private key to configure the CI to use it.
You should also save the generated GitHub App Id.</p>
<p>Once created, you should also limit the usage of this github app to the CI hosts IPs (ipv4 and ipv6).</p>
<p>Application can be now be installed in your organization:</p>
<ul>
<li>Go to <code>https://github.com/organizations/&lt;YOUR ORGANIZATION&gt;/settings/apps</code></li>
<li>Click on the Edit button for our newly created GitHub app</li>
<li>Click on Install App and choose to install it on your organization</li>
</ul>
<p>Example:</p>
<pre><code class="language-bash">roles.github-actions-runner = {
  url = &quot;https://github.com/&lt;YOUR ORGANIZATION&gt;&quot;;
  count = 12;
  name = &quot;github-runner&quot;;
  githubApp = {
    id = &quot;&lt;YOUR GENERATED APP ID&gt;&quot;;
    login = &quot;&lt;YOUR ORGANIZATION&gt;&quot;;
    privateKeyFile = config.age.secrets.github-app-runner-private-key.path;
  };
  cachix.cacheName = &quot;&lt;YOUR CACHIX ORGANIZATION&gt;&quot;;
  cachix.tokenFile = config.age.secrets.cachixToken.path;
};
</code></pre>
<p><a href="https://docs.github.com/en/apps/creating-github-apps/creating-github-apps/creating-a-github-app">Official GitHub App creation documentation</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<ul>
<li><a href="./installation/hetzner_cloud.html">Hetzner Cloud</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hetzner-cloud-installation"><a class="header" href="#hetzner-cloud-installation">Hetzner Cloud installation</a></h1>
<blockquote>
<p>⚠️ Only works with VMs that have more than 2GB of RAM.</p>
</blockquote>
<blockquote>
<p>⚠️ This document reflects more of an ideal than reality right now.</p>
</blockquote>
<ol>
<li>Create the VM in Hetzner Cloud, get the IP, IPv6, set the SSH public key.</li>
<li>Create a new NixOS configuration in your flake:</li>
</ol>
<pre><code class="language-nix">{
  inputs.nixos-anywhere.url = &quot;github:numtide/nixos-anywere&quot;;
  inputs.srvos.url = &quot;github:numtide/srvos&quot;; 
  inputs.disko.url = &quot;github:nix-community/disko&quot;;

  outputs = { self, nixos-remote, srvos, disko, nixpkgs }: {
    nixosConfigurations.my-host = nixpkgs.lib.nixosSystem {
      system = &quot;x86_64-linux&quot;;
      modules = [{ 
        imports = [ 
          srvos.nixosModules.hardware-hetzner-cloud
          srvos.nixosModules.server

          # Are those together?
          disko.nixosModules.disko
          srvos.diskoModules.disk-layout-single-v1
        ];
        networking.hostName = &quot;my-host&quot;;
        # FIXME: Hetzner Cloud doesn't provide us with that configuration
        systemd.network.networks.&quot;10-uplink&quot;.networkConfig.Address = &quot;2a01:4f9:c010:52fd::1/128&quot;;
      }];
    };
    # TODO other $systems
    devShells.x86_64-linux.default = with nixpkgs.legacyPackages.x86_64-linux; mkShellNoCC {
      packages = [
        # TODO: add nixos-rebuild as a package
        nixos-anywhere.packages.x86_64-linux.default
      ];
    };
  };
}
</code></pre>
<ol start="3">
<li>
<p>Update the hostname and IPv6 address in the config.</p>
</li>
<li>
<p>Bootstrap the NixOS deployment:</p>
<pre><code class="language-console">$ nix develop
$ nixos-anywhere --flake .#my-host --target &lt;ip&gt;
</code></pre>
</li>
</ol>
<p>🎉</p>
<ol start="5">
<li>
<p>Pick a nixos deployment tool of your choice! Eg:</p>
<pre><code>$ nixos-rebuild --flake .#my-host --target &lt;ip&gt; switch
</code></pre>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="design"><a class="header" href="#design">Design</a></h1>
<p>This page explains some of the design decisions that have been made trough
this project.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
